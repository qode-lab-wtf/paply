<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>paply Einstellungen</title>
  <style>
    :root {
      /* Light Mode - Same as Dashboard */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F9FAFB;
      --bg-card: #FFFFFF;
      --bg-hover: #F3F4F6;
      --border: #E5E7EB;
      --border-light: #F3F4F6;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --text-muted: #9CA3AF;
      
      /* Accent Colors from Logo */
      --accent-green: #7ED957;
      --accent-green-hover: #6BC448;
      --accent-green-light: #A3E77F;
      --accent-green-bg: rgba(126, 217, 87, 0.1);
      --accent-yellow: #F7D154;
      --accent-yellow-bg: rgba(247, 209, 84, 0.15);
      
      /* Status Colors */
      --accent-blue: #3B82F6;
      --accent-red: #EF4444;
      --success: #7ED957;
      --warning: #F7D154;
      --error: #EF4444;
      
      /* Layout */
      --radius: 10px;
      --radius-sm: 6px;
      --radius-lg: 14px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 20px;
      line-height: 1.5;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(126, 217, 87, 0.25);
    }

    .logo svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--accent-green);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .card-title svg {
      width: 16px;
      height: 16px;
      color: var(--accent-green);
      stroke-width: 2;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 14px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      outline: none;
      transition: all 0.15s ease;
    }

    .form-input:focus {
      border-color: var(--accent-green);
      box-shadow: 0 0 0 3px var(--accent-green-bg);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    select.form-input {
      cursor: pointer;
    }

    /* Toggle Switch */
    .toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .toggle:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .toggle:first-child {
      padding-top: 0;
    }

    .toggle-label {
      font-size: 13px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-label svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: var(--border);
      border-radius: 11px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .toggle-switch.active {
      background: var(--accent-green);
    }

    .toggle-switch.active::after {
      left: 20px;
    }

    /* Info Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-hover);
      border-radius: 50%;
      cursor: help;
      transition: all 0.15s ease;
      position: relative;
    }

    .info-icon:hover {
      color: white;
      background: var(--accent-green);
    }

    .info-icon .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 400;
      white-space: normal;
      text-align: left;
      max-width: 220px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s ease;
      z-index: 100;
      box-shadow: var(--shadow-lg);
      line-height: 1.4;
    }

    .info-icon .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: var(--text-primary);
    }

    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Agent Cards Grid */
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .agent-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .agent-card:hover {
      border-color: var(--accent-green);
      background: var(--accent-green-bg);
    }

    .agent-card.selected {
      border-color: var(--accent-green);
      background: var(--accent-green-bg);
    }

    .agent-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }

    .agent-icon svg {
      width: 14px;
      height: 14px;
      stroke: white;
      stroke-width: 2;
    }

    .agent-name {
      font-size: 12px;
      font-weight: 550;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .agent-hotkey-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 9px;
      padding: 2px 5px;
      background: var(--bg-primary);
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-family: 'SF Mono', monospace;
      font-weight: 500;
    }

    .agent-card.selected .agent-hotkey-badge {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: white;
    }

    /* Hotkey Input Group */
    .hotkey-input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .hotkey-input-group .form-input {
      flex: 1;
      font-family: 'SF Mono', ui-monospace, monospace;
      font-size: 12px;
    }

    .hotkey-input-group .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--accent-green);
      color: white;
      box-shadow: 0 1px 3px rgba(126, 217, 87, 0.2);
    }

    .btn-primary:hover {
      background: var(--accent-green-hover);
      box-shadow: 0 2px 6px rgba(126, 217, 87, 0.3);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    /* Footer Buttons */
    .footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* Status Message */
    .status {
      font-size: 12px;
      color: var(--success);
      margin-top: 10px;
      text-align: right;
    }

    .status.error {
      color: var(--error);
    }

    /* Scrollable content */
    .scroll-area {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    /* Empty state for custom agents */
    .empty-agents {
      text-align: center;
      padding: 16px;
      color: var(--text-muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
    </div>
    <h1>Einstellungen</h1>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="general">Allgemein</button>
    <button class="tab" data-tab="agents">Agenten</button>
    <button class="tab" data-tab="api">API Keys</button>
  </div>

  <div class="scroll-area">
    <!-- General Tab -->
    <div class="tab-content active" id="tab-general">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Tastenk√ºrzel
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">
            Globaler Hotkey
            <span class="info-icon">i<span class="tooltip">Tastenkombination zum Starten und Stoppen der Aufnahme. Klicke ins Feld und dr√ºcke die gew√ºnschte Kombination.</span></span>
          </label>
          <input type="text" class="form-input" id="shortcut" readonly placeholder="Klicken und Tastenkombination dr√ºcken">
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            </svg>
            Transkription
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Sprache</label>
          <select class="form-input" id="language">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
            </svg>
            Optionen
          </div>
        </div>
        
        <div class="toggle">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18l6-6-6-6"/></svg>
            Polish aktivieren
          </span>
          <span class="info-icon" style="margin-right: auto; margin-left: 6px;">i<span class="tooltip">Verbessert den Text mit KI ‚Äì korrigiert Grammatik und Zeichensetzung. Ben√∂tigt Anthropic API Key.</span></span>
          <div class="toggle-switch" id="togglePolish"></div>
        </div>

        <div class="toggle">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
            Auto-Paste
          </span>
          <span class="info-icon" style="margin-right: auto; margin-left: 6px;">i<span class="tooltip">F√ºgt den Text automatisch ins vorherige Fenster ein.</span></span>
          <div class="toggle-switch" id="toggleAutopaste"></div>
        </div>

        <div class="toggle" id="copyClipboardRow">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            In Zwischenablage kopieren
          </span>
          <span class="info-icon" style="margin-right: auto; margin-left: 6px;">i<span class="tooltip">Kopiert den Text in die Zwischenablage. Nur wenn Auto-Paste deaktiviert ist.</span></span>
          <div class="toggle-switch" id="toggleCopyClipboard"></div>
        </div>

        <div class="toggle">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            Piep-Sound abspielen
          </span>
          <div class="toggle-switch" id="toggleBeep"></div>
        </div>

        <div class="toggle">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
            Bei Anmeldung automatisch starten
          </span>
          <div class="toggle-switch" id="toggleAutoStart"></div>
        </div>

        <div class="toggle">
          <span class="toggle-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>
            Dock-Icon verstecken
          </span>
          <span class="info-icon" style="margin-right: auto; margin-left: 6px;">i<span class="tooltip">Versteckt das App-Symbol im Dock. paply ist dann nur im Tray sichtbar.</span></span>
          <div class="toggle-switch" id="toggleHideDock"></div>
        </div>
      </div>
    </div>

    <!-- Agents Tab -->
    <div class="tab-content" id="tab-agents">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
            </svg>
            Standard-Agenten
          </div>
        </div>
        
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
          Klicke auf einen Agenten, um seinen Hotkey zu √§ndern.
        </p>

        <div class="agents-grid">
          <!-- Coding Agent -->
          <div class="agent-card" data-agent="coding">
            <span class="agent-hotkey-badge" id="codingHotkeyBadge">‚åò1</span>
            <div class="agent-icon" style="background: #3B82F6;">
              <svg viewBox="0 0 24 24" fill="none">
                <polyline points="16 18 22 12 16 6"/>
                <polyline points="8 6 2 12 8 18"/>
              </svg>
            </div>
            <div class="agent-name">Coding</div>
          </div>

          <!-- Meeting Agent -->
          <div class="agent-card" data-agent="meeting">
            <span class="agent-hotkey-badge" id="meetingHotkeyBadge">‚åò2</span>
            <div class="agent-icon" style="background: #F7D154;">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              </svg>
            </div>
            <div class="agent-name">Meeting</div>
          </div>

          <!-- Dictation Agent -->
          <div class="agent-card" data-agent="dictation">
            <span class="agent-hotkey-badge" id="dictationHotkeyBadge">‚åò3</span>
            <div class="agent-icon" style="background: #7ED957;">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </div>
            <div class="agent-name">Diktat</div>
          </div>
        </div>

        <!-- Selected Agent Hotkey Editor -->
        <div id="standardAgentEditor" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
          <div class="form-group">
            <label class="form-label">
              Hotkey f√ºr <strong id="selectedAgentName">Coding</strong>
              <span class="info-icon">i<span class="tooltip">Dr√ºcke die gew√ºnschte Tastenkombination z.B. Cmd+1 oder Alt+C</span></span>
            </label>
            <div class="hotkey-input-group">
              <input type="text" class="form-input" id="standardAgentHotkey" readonly placeholder="Klicken und Tasten dr√ºcken">
              <button class="btn btn-secondary btn-icon" id="clearStandardHotkey" title="Hotkey l√∂schen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <button class="btn btn-primary btn-icon" id="saveStandardHotkey" title="Speichern">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            Eigene Agenten
          </div>
        </div>
        
        <div id="customAgentsList">
          <div class="empty-agents">
            Keine eigenen Agenten vorhanden. Erstelle sie im Dashboard.
          </div>
        </div>
      </div>
    </div>

    <!-- API Keys Tab -->
    <div class="tab-content" id="tab-api">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
            </svg>
            API Keys
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">
            Groq API Key (erforderlich)
            <span class="info-icon">i<span class="tooltip">Kostenloser Key von console.groq.com. Wird f√ºr die Sprache-zu-Text Umwandlung verwendet.</span></span>
          </label>
          <input type="password" class="form-input" id="groqKey" placeholder="gsk_...">
        </div>

        <div class="form-group">
          <label class="form-label">
            Anthropic API Key (optional)
            <span class="info-icon">i<span class="tooltip">Optional. Verbessert den transkribierten Text mit KI ‚Äì korrigiert Grammatik und Zeichensetzung.</span></span>
          </label>
          <input type="password" class="form-input" id="haikuKey" placeholder="sk-ant-...">
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button class="btn btn-secondary" id="cancelBtn">Abbrechen</button>
    <button class="btn btn-primary" id="saveBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      Speichern
    </button>
  </div>

  <div id="status" class="status"></div>

  <script>
    // Elements
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    const groqKeyInput = document.getElementById('groqKey');
    const haikuKeyInput = document.getElementById('haikuKey');
    const togglePolish = document.getElementById('togglePolish');
    const toggleAutopaste = document.getElementById('toggleAutopaste');
    const toggleCopyClipboard = document.getElementById('toggleCopyClipboard');
    const toggleBeep = document.getElementById('toggleBeep');
    const toggleAutoStart = document.getElementById('toggleAutoStart');
    const toggleHideDock = document.getElementById('toggleHideDock');
    const languageSelect = document.getElementById('language');
    const shortcutInput = document.getElementById('shortcut');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusEl = document.getElementById('status');
    
    // Agent hotkey elements
    const standardAgentEditor = document.getElementById('standardAgentEditor');
    const selectedAgentName = document.getElementById('selectedAgentName');
    const standardAgentHotkey = document.getElementById('standardAgentHotkey');
    const clearStandardHotkey = document.getElementById('clearStandardHotkey');
    const saveStandardHotkey = document.getElementById('saveStandardHotkey');

    let originalSettings = {};
    let platformInfo = { isMac: true, isWin: false };
    let selectedStandardAgent = null;
    let customAgents = [];
    let standardAgentHotkeys = {
      coding: null,
      meeting: null,
      dictation: null
    };

    // Tab Switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabId = tab.dataset.tab;
        tabContents.forEach(content => {
          content.classList.toggle('active', content.id === `tab-${tabId}`);
        });
      });
    });

    // Toggle Switch Handler
    function setupToggle(element, initialValue, onChange) {
      if (initialValue) element.classList.add('active');
      element.addEventListener('click', () => {
        element.classList.toggle('active');
        if (onChange) onChange(element.classList.contains('active'));
      });
    }

    // Get platform-specific hotkey symbol
    function getPlatformHotkey(number) {
      return platformInfo.isMac ? `‚åò${number}` : `Ctrl+${number}`;
    }
    
    // Format hotkey for display
    function formatHotkeyForDisplay(hotkey) {
      if (!hotkey) return '';
      if (platformInfo.isMac) {
        return hotkey.replace('Command', '‚åò').replace('Control', 'Ctrl').replace('Alt', '‚å•').replace('Shift', '‚áß');
      } else {
        return hotkey.replace('Command', 'Ctrl');
      }
    }

    // Update Copy to Clipboard state based on autopaste
    function updateCopyClipboardState() {
      const isAutopasteActive = toggleAutopaste.classList.contains('active');
      const copyRow = document.getElementById('copyClipboardRow');
      
      if (isAutopasteActive) {
        toggleCopyClipboard.classList.remove('active');
        copyRow.style.opacity = '0.5';
        copyRow.style.pointerEvents = 'none';
      } else {
        copyRow.style.opacity = '1';
        copyRow.style.pointerEvents = 'auto';
      }
    }

    // Update hotkey badges for standard agents
    function updateHotkeyBadges() {
      const codingBadge = document.getElementById('codingHotkeyBadge');
      const meetingBadge = document.getElementById('meetingHotkeyBadge');
      const dictationBadge = document.getElementById('dictationHotkeyBadge');
      
      codingBadge.textContent = standardAgentHotkeys.coding 
        ? formatHotkeyForDisplay(standardAgentHotkeys.coding)
        : getPlatformHotkey(1);
      meetingBadge.textContent = standardAgentHotkeys.meeting
        ? formatHotkeyForDisplay(standardAgentHotkeys.meeting)
        : getPlatformHotkey(2);
      dictationBadge.textContent = standardAgentHotkeys.dictation
        ? formatHotkeyForDisplay(standardAgentHotkeys.dictation)
        : getPlatformHotkey(3);
    }

    // Load Settings
    async function loadSettings() {
      try {
        platformInfo = await window.electronAPI.getPlatform();
      } catch (e) {
        console.log('Platform detection not available');
      }
      
      const settings = await window.electronAPI.getSettings();
      originalSettings = { ...settings };
      
      // Load profiles to get standard agent hotkeys
      const profileData = await window.electronAPI.getProfiles();
      standardAgentHotkeys = {
        coding: profileData.profiles?.coding?.hotkey || null,
        meeting: profileData.profiles?.meeting?.hotkey || null,
        dictation: profileData.profiles?.dictation?.hotkey || null
      };
      
      // Load custom agents
      customAgents = profileData.customAgents || [];
      renderCustomAgents();
      
      const defaultShortcut = platformInfo.isMac ? 'Alt+Command+K' : 'Ctrl+Alt+K';
      
      groqKeyInput.value = settings.groqApiKey || '';
      haikuKeyInput.value = settings.haikuApiKey || '';
      languageSelect.value = settings.language || 'de';
      shortcutInput.value = settings.shortcut || defaultShortcut;
      
      // Setup toggles
      setupToggle(togglePolish, settings.enablePolish || false);
      setupToggle(toggleAutopaste, settings.autopaste !== false, updateCopyClipboardState);
      setupToggle(toggleCopyClipboard, settings.copyToClipboard || false);
      setupToggle(toggleBeep, settings.beepEnabled !== false);
      setupToggle(toggleAutoStart, settings.autoStart || false);
      setupToggle(toggleHideDock, settings.hideDock || false);
      
      updateCopyClipboardState();
      updateHotkeyBadges();
    }

    // Render custom agents
    function renderCustomAgents() {
      const container = document.getElementById('customAgentsList');
      
      if (customAgents.length === 0) {
        container.innerHTML = '<div class="empty-agents">Keine eigenen Agenten vorhanden. Erstelle sie im Dashboard.</div>';
        return;
      }
      
      container.innerHTML = customAgents.map((agent, index) => `
        <div class="agent-card" data-custom-agent="${agent.id}" style="margin-bottom: 8px;">
          <span class="agent-hotkey-badge">${agent.hotkey ? formatHotkeyForDisplay(agent.hotkey) : '‚Äî'}</span>
          <div class="agent-icon" style="background: ${agent.color || '#7ED957'};">
            <span style="font-size: 14px;">${agent.icon || 'üéØ'}</span>
          </div>
          <div class="agent-name">${agent.name}</div>
        </div>
      `).join('');
      
      // Add click handlers
      container.querySelectorAll('.agent-card').forEach(card => {
        card.addEventListener('click', () => selectCustomAgent(card.dataset.customAgent));
      });
    }

    // Select custom agent for hotkey editing
    let selectedCustomAgent = null;
    
    function selectCustomAgent(agentId) {
      selectedCustomAgent = customAgents.find(a => a.id === agentId);
      if (!selectedCustomAgent) return;
      
      // Deselect standard agents
      document.querySelectorAll('.agent-card[data-agent]').forEach(c => c.classList.remove('selected'));
      selectedStandardAgent = null;
      standardAgentEditor.style.display = 'none';
      
      // Select this agent
      document.querySelectorAll('.agent-card[data-custom-agent]').forEach(c => {
        c.classList.toggle('selected', c.dataset.customAgent === agentId);
      });
      
      // Show editor (reuse standard agent editor)
      standardAgentEditor.style.display = 'block';
      selectedAgentName.textContent = selectedCustomAgent.name;
      standardAgentHotkey.value = selectedCustomAgent.hotkey || '';
    }

    // Standard Agent Card Selection
    document.querySelectorAll('.agent-card[data-agent]').forEach(card => {
      card.addEventListener('click', () => {
        const agentId = card.dataset.agent;
        
        // Deselect custom agents
        document.querySelectorAll('.agent-card[data-custom-agent]').forEach(c => c.classList.remove('selected'));
        selectedCustomAgent = null;
        
        // Toggle selection
        const wasSelected = card.classList.contains('selected');
        document.querySelectorAll('.agent-card[data-agent]').forEach(c => c.classList.remove('selected'));
        
        if (wasSelected) {
          standardAgentEditor.style.display = 'none';
          selectedStandardAgent = null;
        } else {
          card.classList.add('selected');
          selectedStandardAgent = agentId;
          
          // Show editor
          standardAgentEditor.style.display = 'block';
          const names = { coding: 'Coding', meeting: 'Meeting', dictation: 'Diktat' };
          selectedAgentName.textContent = names[agentId];
          
          // Show current hotkey
          const defaultHotkeys = {
            coding: platformInfo.isMac ? 'Command+1' : 'Ctrl+1',
            meeting: platformInfo.isMac ? 'Command+2' : 'Ctrl+2',
            dictation: platformInfo.isMac ? 'Command+3' : 'Ctrl+3'
          };
          standardAgentHotkey.value = standardAgentHotkeys[agentId] || defaultHotkeys[agentId];
        }
      });
    });

    // Hotkey Capture for Standard Agent
    let isCapturingAgentHotkey = false;
    
    standardAgentHotkey.addEventListener('click', () => {
      isCapturingAgentHotkey = true;
      standardAgentHotkey.value = 'Dr√ºcke Tastenkombination...';
      standardAgentHotkey.style.borderColor = 'var(--accent-green)';
    });
    
    standardAgentHotkey.addEventListener('blur', () => {
      if (isCapturingAgentHotkey) {
        isCapturingAgentHotkey = false;
        const agentId = selectedStandardAgent || selectedCustomAgent?.id;
        if (selectedStandardAgent) {
          const defaultHotkeys = {
            coding: platformInfo.isMac ? 'Command+1' : 'Ctrl+1',
            meeting: platformInfo.isMac ? 'Command+2' : 'Ctrl+2',
            dictation: platformInfo.isMac ? 'Command+3' : 'Ctrl+3'
          };
          standardAgentHotkey.value = standardAgentHotkeys[agentId] || defaultHotkeys[agentId];
        } else if (selectedCustomAgent) {
          standardAgentHotkey.value = selectedCustomAgent.hotkey || '';
        }
        standardAgentHotkey.style.borderColor = '';
      }
    });
    
    // Helper: Extrahiert den lesbaren Tastennamen aus e.code
    function getKeyNameFromCode(code) {
      if (code.startsWith('Key')) return code.slice(3); // "KeyX" -> "X"
      if (code.startsWith('Digit')) return code.slice(5); // "Digit1" -> "1"
      if (code.startsWith('Numpad')) return 'Num' + code.slice(6); // "Numpad1" -> "Num1"
      // Spezielle Tasten
      const specialKeys = {
        'Space': 'Space', 'Backspace': 'Backspace', 'Tab': 'Tab', 'Enter': 'Enter',
        'Escape': 'Escape', 'Delete': 'Delete', 'Home': 'Home', 'End': 'End',
        'PageUp': 'PageUp', 'PageDown': 'PageDown', 'ArrowUp': 'Up', 'ArrowDown': 'Down',
        'ArrowLeft': 'Left', 'ArrowRight': 'Right', 'Insert': 'Insert',
        'F1': 'F1', 'F2': 'F2', 'F3': 'F3', 'F4': 'F4', 'F5': 'F5', 'F6': 'F6',
        'F7': 'F7', 'F8': 'F8', 'F9': 'F9', 'F10': 'F10', 'F11': 'F11', 'F12': 'F12',
        'Minus': '-', 'Equal': '=', 'BracketLeft': '[', 'BracketRight': ']',
        'Semicolon': ';', 'Quote': "'", 'Backquote': '`', 'Backslash': '\\',
        'Comma': ',', 'Period': '.', 'Slash': '/'
      };
      return specialKeys[code] || code;
    }
    
    function isModifierCode(code) {
      return ['ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'ShiftLeft', 'ShiftRight', 'MetaLeft', 'MetaRight'].includes(code);
    }

    standardAgentHotkey.addEventListener('keydown', (e) => {
      if (!isCapturingAgentHotkey) return;
      e.preventDefault();
      
      const parts = [];
      if (e.ctrlKey) parts.push('Control');
      if (e.altKey) parts.push('Alt');
      if (e.shiftKey) parts.push('Shift');
      if (e.metaKey) parts.push('Command');
      
      if (!isModifierCode(e.code)) {
        parts.push(getKeyNameFromCode(e.code).toUpperCase());
      }
      
      if (parts.length >= 2 && !isModifierCode(e.code)) {
        standardAgentHotkey.value = parts.join('+');
        isCapturingAgentHotkey = false;
        standardAgentHotkey.style.borderColor = '';
        standardAgentHotkey.blur();
      }
    });
    
    // Clear hotkey
    clearStandardHotkey.addEventListener('click', () => {
      standardAgentHotkey.value = '';
    });
    
    // Save agent hotkey
    saveStandardHotkey.addEventListener('click', async () => {
      const hotkey = standardAgentHotkey.value.trim();
      
      if (selectedStandardAgent) {
        standardAgentHotkeys[selectedStandardAgent] = hotkey || null;
        updateHotkeyBadges();
        showStatus('Hotkey gespeichert!');
      } else if (selectedCustomAgent) {
        try {
          await window.electronAPI.updateAgentHotkey(selectedCustomAgent.id, hotkey);
          selectedCustomAgent.hotkey = hotkey;
          renderCustomAgents();
          showStatus('Hotkey gespeichert!');
        } catch (err) {
          showStatus('Fehler beim Speichern', true);
        }
      }
    });

    // Global Shortcut Capture
    let isCapturingShortcut = false;

    shortcutInput.addEventListener('click', () => {
      isCapturingShortcut = true;
      shortcutInput.value = 'Dr√ºcke Tastenkombination...';
      shortcutInput.style.borderColor = 'var(--accent-green)';
    });

    shortcutInput.addEventListener('blur', () => {
      if (isCapturingShortcut) {
        isCapturingShortcut = false;
        const defaultShortcut = platformInfo.isMac ? 'Alt+Command+K' : 'Ctrl+Alt+K';
        shortcutInput.value = originalSettings.shortcut || defaultShortcut;
        shortcutInput.style.borderColor = '';
      }
    });

    shortcutInput.addEventListener('keydown', (e) => {
      if (!isCapturingShortcut) return;
      e.preventDefault();

      const parts = [];
      if (e.ctrlKey) parts.push('Control');
      if (e.altKey) parts.push('Alt');
      if (e.shiftKey) parts.push('Shift');
      if (e.metaKey) parts.push('Command');

      if (!isModifierCode(e.code)) {
        parts.push(getKeyNameFromCode(e.code).toUpperCase());
      }

      if (parts.length >= 2 && !isModifierCode(e.code)) {
        shortcutInput.value = parts.join('+');
        isCapturingShortcut = false;
        shortcutInput.style.borderColor = '';
        shortcutInput.blur();
      }
    });

    // Show status message
    function showStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }

    // Save Settings
    saveBtn.addEventListener('click', async () => {
      const settings = {
        groqApiKey: groqKeyInput.value.trim(),
        haikuApiKey: haikuKeyInput.value.trim(),
        enablePolish: togglePolish.classList.contains('active'),
        autopaste: toggleAutopaste.classList.contains('active'),
        copyToClipboard: toggleCopyClipboard.classList.contains('active'),
        beepEnabled: toggleBeep.classList.contains('active'),
        autoStart: toggleAutoStart.classList.contains('active'),
        hideDock: toggleHideDock.classList.contains('active'),
        language: languageSelect.value,
        shortcut: shortcutInput.value,
      };

      try {
        await window.electronAPI.setSettings(settings);
        
        // Save standard agent hotkeys (including cleared ones as empty string)
        for (const agentId of ['coding', 'meeting', 'dictation']) {
          if (standardAgentHotkeys[agentId] !== null) {
            await window.electronAPI.updateProfile(agentId, { hotkey: standardAgentHotkeys[agentId] });
          } else if (standardAgentHotkeys[agentId] === null) {
            await window.electronAPI.updateProfile(agentId, { hotkey: '' });
          }
        }
        
        showStatus('Gespeichert!');
        setTimeout(() => window.close(), 500);
      } catch (err) {
        showStatus('Fehler beim Speichern', true);
      }
    });

    // Cancel
    cancelBtn.addEventListener('click', () => {
      window.close();
    });

    // Init
    loadSettings();
  </script>
</body>
</html>
